ARG FROM_TAG
FROM zephyrprojectrtos/ci:${FROM_TAG:-latest}

RUN dpkg --add-architecture i386 && \
        apt-get -y update && \
        apt-get -y upgrade && \
        apt-get install --no-install-recommends -y \
	openbox \
	python-xdg \
	libpython3.8-dev \
	x11vnc \
	xvfb \
	xterm \
	xz-utils \
        indent \
        cppcheck \
        vim \
        tree && \
	rm -rf /var/lib/apt/lists/*

# rber: added above:
#       indent, cppcheck, vim, tree

# --> rber
RUN /usr/bin/python3 -m pip install --upgrade pip
RUN /usr/bin/python3 -m pip install --upgrade pip
RUN pip3 install -r https://raw.githubusercontent.com/zephyrproject-rtos/zephyr/zephyr-v2.6.0/scripts/requirements.txt
RUN /usr/bin/python3 -m pip install --upgrade pip
RUN pip3 install -r https://raw.githubusercontent.com/zephyrproject-rtos/zephyr/zephyr-v2.6.0/scripts/requirements.txt
# <-- rber

# --> rber
# extra config files rber wants in sdk container
COPY etc/skel/gitconfig /etc/skel/.gitconfig

# key which is known to gitpod
COPY etc/skel/ssh/.          /etc/skel/.ssh/
# <-- rber

ENV DISPLAY=:0
ENV ZEPHYR_BASE=/workdir/zephyr

ADD ./entrypoint.sh /home/user/entrypoint.sh
ADD ./bash_completion /home/user/.bash_completion
RUN mkdir -p /home/user/.bash_completion.d
RUN chown -R user:user /home/user

RUN dos2unix /home/user/entrypoint.sh

EXPOSE 5900

ENTRYPOINT ["/home/user/entrypoint.sh"]
CMD ["/bin/bash"]
USER user

WORKDIR /workdir
VOLUME ["/workdir"]


ARG VNCPASSWD=zephyr
RUN mkdir ~/.vnc && x11vnc -storepasswd ${VNCPASSWD} ~/.vnc/passwd

